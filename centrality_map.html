<!DOCTYPE html>
<head>
	<meta charset='utf-8' />
    <title>Seattle Congestion Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>
	<style>
	.boxdraw {
		background: rgba(100,100,100,0.1);
		border: 2px solid #3887be;
		position: absolute;
		top: 0;
		left: 0;
		width: 0;
		height: 0;
	}
	.map-overlay{
		font:12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
		position: absolute;
		width: 250px;
		top: 0;
		left: 0;
		padding: 10px;
	}
	.map-overlay .map-overlay-inner{
		background-color: #fff;
		padding: 10px;
		margin-bottom: 10px;
	}
	</style>
	<div id='map'></div>

    <div class='map-overlay top'>
        <div class='map-overlay-inner'>
            <fieldset>
                <label>Select Measure</label>
                <select id='layer' name='layer'>
                    <option value='edge_bet'>Edge Betweenness Centrality</option>
                </select>
            </fieldset>
        </div>
    </div>

	<script>
		mapboxgl.accessToken = 'pk.eyJ1IjoibG9nYW55ZyIsImEiOiJjajlnMG82OHUyc2s0MzJtcWQxM2s5a3puIn0.u0B6MIr8Hwl3ICfqHGYxwA';
		var map = new mapboxgl.Map({
		    container: 'map',
		    style: 'mapbox://styles/mapbox/light-v9',
		    center: [-122.3321, 47.6062],
		    zoom: 10
		});

		map.boxZoom.disable();
		var startLngLat;
		var selectFinished;
		var firstSource = true;
		map.on('load', function() {
			selectFinished = true;
			var canvas = map.getCanvasContainer();
			var start;
			var current;
			var box;
			canvas.addEventListener('mousedown', mouseDown, true);
			function mousePos(e){
				var rect = canvas.getBoundingClientRect();
				return new mapboxgl.Point(
					e.clientX - rect.left - canvas.clientLeft,
					e.clientY - rect.top - canvas.clientTop
				);
			}
			function mouseDown(e){
				if(!(e.shiftKey && e.button === 0)) return;
				map.dragPan.disable();
				// Add listeners to check for changes to the selected box
				document.addEventListener('mousemove', onMouseMove);
		        document.addEventListener('mouseup', onMouseUp);
		        document.addEventListener('keydown', onKeyDown);
		        start = mousePos(e);
			}
			function onMouseMove(e){
				current = mousePos(e);
				// If the box doesn't exist, create it
				if (!box) {
					box = document.createElement('div');
					box.classList.add('boxdraw');
					canvas.appendChild(box);
				}
				// Determine where the top left and bottom right corners of the box are on the screen
				var minX = Math.min(start.x, current.x),
		            maxX = Math.max(start.x, current.x),
		            minY = Math.min(start.y, current.y),
		            maxY = Math.max(start.y, current.y);
		        var pos = 'translate(' + minX + 'px,' + minY + 'px)';
		        // Assign attributes to the box based on the bottom right and top left corners
		        box.style.transform = pos;
		        box.style.WebkitTransform = pos;
		        box.style.width = maxX - minX + 'px';
		        box.style.height = maxY - minY + 'px';
			}
			function onMouseUp(e){
				// Run the finisher function on the coordinates of the
				// selected box when mouse is released.
				finish();
			}
			function onKeyDown(e){
				// If escape is pressed, cancel the selection.
				if (e.keyCode === 27) finish();
			}
			function finish(){
				// Remove these events now that finish has been called.
		        document.removeEventListener('mousemove', onMouseMove);
		        document.removeEventListener('keydown', onKeyDown);
		        document.removeEventListener('mouseup', onMouseUp);
		        if (box) {
		        	// Clear saved box, return to pre-click state
		            box.parentNode.removeChild(box);
		            box = null;
		        }

		        map.dragPan.enable();
			}
		});
		map.on("mousedown", function(e) {
			if(e.originalEvent.shiftKey){
				startLngLat = e.lngLat;
				selectFinished = false;
			}
		});
		map.on("mouseup", function(e) {
			if(!selectFinished){
				selectFinished = true;
				var startLat = Math.min(startLngLat.lat, e.lngLat.lat);
				var startLng = Math.min(startLngLat.lng, e.lngLat.lng);
				var endLat = Math.max(startLngLat.lat, e.lngLat.lat);
				var endLng = Math.max(startLngLat.lng, e.lngLat.lng);
				if(!firstSource){
					map.removeSource('Pedways');
					map.removeLayer('Pedways-lines');
				}else{
					firstSource = false;
				}
				map.addSource('Pedways', {
					'type': 'geojson',
					'data': 'http://127.0.0.1:5000/centrality.geojson?lat_1=' + startLat + '&lon_1=' + startLng + '&lat_2=' + endLat + '&lon_2=' + endLng
				});
				map.addLayer({
			        "id": "Pedways-lines",
			        "type": "line",
			        "source": "Pedways",
			        "layout": {
			            "line-join": "round",
			            "line-cap": "round"
			        },
			        "paint": {
			            "line-color": {
			            	property: "centrality",
			            	stops: [
				            	[0.0, '#F2F12D'],
			                    [0.001, '#EED322'],
			                    [0.002, '#E6B71E'],
			                    [0.003, '#DA9C20'],
			                    [0.004, '#CA8323'],
			                    [0.005, '#B86B25'],
			                    [0.006, '#A25626'],
			                    [0.007, '#8B4225'],
			                    [0.008, '#723122']
			            	]
			            },
			            "line-width": 4
			        }
			    });
			}
		});
	</script>

</body>